name: CDK8s Synth for Go

on:
  push:
    branches: [ master ]
    paths:
      - 'main.go'
      - '.github/workflows/ci-cdk8s-synth.yaml'

jobs:
  synthesize:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: 1.22.2

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install CDK8s CLI
      run: npm install -g cdk8s-cli

    - name: Install project dependencies
      run: npm install

    - name: Go mod tidy
      run: go mod tidy

    - name: Synthesize Kubernetes YAML using CDK8s
      run: |
        mkdir -p temp-synth-output
        cdk8s synth --app "go run main.go" --output temp-synth-output

    - name: Copy synthesized files to Helm chart
      run: |
        mkdir -p helm/go-web-app-chart/templates
        for file in temp-synth-output/*.k8s.yaml; do
          name=$(basename "$file")
          cp "$file" "helm/go-web-app-chart/templates/synth-${name}"
        done

    - name: Commit synthesized files (if changed)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.email "lingammani2@gmail.com"
        git config --global user.name "rushimanikantalingam"
        git add helm/go-web-app-chart/templates/synth-*
        git diff --cached --quiet || git commit -m "Add/update synthesized Kubernetes YAML using CDK8s"
        git pull origin master --rebase
        git push
